<script>
'use strict';

var _tracker2 = require('meteor/tracker');

var _underscore = require('meteor/underscore');

var _ejson = require('meteor/ejson');

var _random = require('meteor/random');

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var mwcDataUpdate = function mwcDataUpdate(element) {
  var el = element;
  var data = element.getMeteorData();

  if (!data) {
    return;
  }

  if (el.__mwcFirstRun) {
    el.__mwcFirstRun = false;
    el._mwcSetData(data);
    return;
  }

  _tracker2.Tracker.afterFlush(function () {
    el._mwcSetData(data);
  });
};

mwcMixin = {
  properties: {
    subsReady: { type: Boolean, notify: true, value: true },
    mwcData: Object,
    __mwcHandles: { type: Array, value: [] },
    __mwcPush: { type: Array, value: [] },
    __mwcComputations: { type: Array, value: [] },
    __mwcComputationsIds: { type: Array, value: [] },
    __mwcBin: { type: Array, value: [] }
  },
  trackers: [],
  _mwcSetData: function _mwcSetData(data) {
    this.set('mwcData', data);
  },
  beforeRegister: function beforeRegister() {
    var _this = this;

    var mwcDeps = {};
    var trackers = this.trackers;

    var _loop = function _loop(i) {
      var tracker = trackers[i];
      var sections = tracker.split(/[()]+/);
      var input = sections[1];
      var cb = sections[0];
      var rId = '__mwc_' + _random.Random.id(10);
      var obj = {
        _id: rId,
        cb: cb
      };
      var dep = new _tracker2.Tracker.Dependency();
      var _trObFn = function _trObFn() {
        // eslint-disable-line func-names
        var _obj = obj;

        for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
          args[_key] = arguments[_key];
        }

        _obj.args = args;
        this.__mwcDeps[tracker] = _obj;
        this.__mwcDeps[tracker] = _underscore._.clone(this.__mwcDeps[tracker]);
        this.__mwcDeps = _underscore._.clone(this.__mwcDeps);
        dep.changed();
      };
      var obFn = function obFn() {
        // eslint-disable-line func-names
        var _obj = this.__mwcDeps[tracker];
        var args = _obj.args || [];
        dep.depend();
        this[_obj.cb].apply(this, _toConsumableArray(args));
      };
      obj.obFn = obFn;
      mwcDeps[tracker] = obj;

      _this[rId] = _trObFn;
      _this._createPropertyObserver(input, rId);
    };

    for (var i = 0; i < trackers.length; i += 1) {
      _loop(i);
    }
    this.__mwcDeps = mwcDeps;
  },
  attached: function attached() {
    this.__mwcFirstRun = true;
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = Object.keys(this.__mwcDeps)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var _tracker = _step.value;

        var _obj = this.__mwcDeps[_tracker];
        this.autorun(_obj.obFn.bind(this));
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.autorun(this.tracker);
    this.autorun(mwcDataUpdate.bind(null, this));
  },
  detached: function detached() {
    _underscore._.each(this.__mwcComputations, function (c) {
      c.stop();
    });
    this.__mwcComputations = [];
    this.__mwcHandles.forEach(function (h) {
      h.stop();
    });
    this.__mwcBin.forEach(function (h) {
      h.stop();
    });
  },
  _mwcPush: function _mwcPush(p, val) {
    var prop = _underscore._.clone(this[p]);
    prop.push(val);
    this.set(p, prop);
  },
  guard: function guard(f) {
    if (Meteor.isServer || !_tracker2.Tracker.currentComputation) {
      return f();
    }

    var dep = new _tracker2.Tracker.Dependency();
    dep.depend();

    var value = void 0;
    var newValue = void 0;
    _tracker2.Tracker.autorun(function (comp) {
      newValue = f();
      if (!comp.firstRun && !_ejson.EJSON.equals(newValue, value)) {
        dep.changed();
      }
      value = _ejson.EJSON.clone(newValue);
    });
    return newValue;
  },
  autorun: function autorun(f) {
    var _this2 = this;

    var cb = function cb(c) {
      if (!_underscore._.find(_this2.__mwcComputationsIds, function (_id) {
        return _id === c._id;
      })) {
        _this2._mwcPush('__mwcComputationsIds', c._id);
        _this2._mwcPush('__mwcComputations', c);
      }
      f.bind(_this2)(c);
    };
    return _tracker2.Tracker.autorun(cb.bind(this));
  },
  _removeSubs: function _removeSubs(val) {
    var handles = _underscore._.reject(_underscore._.clone(this.__mwcHandles), function (h) {
      if (h.subscriptionId === val.subscriptionId) {
        return true;
      }
      return false;
    });
    this._mwcPush('__mwcBin', val);
    this.set('__mwcHandles', handles);
  },
  subscribe: function subscribe() {
    var _this3 = this;

    for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
      args[_key2] = arguments[_key2];
    }

    var handle = Meteor.subscribe.apply(null, args);
    this._mwcPush('__mwcHandles', handle);
    this._subsReady();
    var afterSub = function afterSub(c) {
      if (handle.ready()) {
        _this3._removeSubs(handle);
        _this3._subsReady();
        c.stop();
      }
    };
    this.autorun(afterSub.bind(this));
    return handle;
  },
  _subsReady: function _subsReady() {
    var isReady = _underscore._.every(this.__mwcHandles, function (sub) {
      return sub && sub.ready();
    });
    this.set('subsReady', isReady);
    return isReady;
  },
  getMeteorData: function getMeteorData() {},
  tracker: function tracker() {}
};
</script>
